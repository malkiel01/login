<?php
/**
 * ×¡×§×¨×™×¤×˜ ×œ×ª×™×§×•×Ÿ ××•×˜×•××˜×™ ×©×œ ××—×™×“×•×ª ×”×˜×¤×¡×™×
 * ××™×§×•×: /dashboard/dashboards/cemeteries/forms/fix-forms-uniformity.php
 * 
 * @author Assistant
 * @version 1.0.0
 */

class FormUniformityFixer {
    
    private $formsPath;
    private $backupPath;
    private $dryRun;
    private $fixedCount = 0;
    private $errors = [];
    private $log = [];
    
    // ×¨×©×™××ª ×§×‘×¦×™ ×”×˜×¤×¡×™× ×œ×ª×™×§×•×Ÿ
    private $formFiles = [
        'country-form.php',
        'city-form.php',
        'customer-form.php',
        'payment-form.php',
        'purchase-form.php',
        'burial-form.php',
        'residency-form.php',
        // ×”×•×¡×£ ×§×‘×¦×™× × ×•×¡×¤×™× ×›××Ÿ
    ];
    
    public function __construct($dryRun = true) {
        $this->formsPath = __DIR__;
        $this->backupPath = __DIR__ . '/backup_' . date('Y-m-d_His');
        $this->dryRun = $dryRun;
    }
    
    /**
     * ×”×¨×¦×ª ×”×ª×™×§×•×Ÿ
     */
    public function run() {
        $this->log("ğŸš€ ××ª×—×™×œ ×ª×™×§×•×Ÿ ××—×™×“×•×ª ×˜×¤×¡×™×");
        $this->log("ğŸ“ × ×ª×™×‘: " . $this->formsPath);
        $this->log("ğŸ”§ ××¦×‘: " . ($this->dryRun ? "×‘×“×™×§×” ×‘×œ×‘×“ (Dry Run)" : "×‘×™×¦×•×¢ ×ª×™×§×•× ×™×"));
        $this->log(str_repeat("-", 60));
        
        // ×™×¦×™×¨×ª ×’×™×‘×•×™ ×× ×œ× ×‘××¦×‘ dry run
        if (!$this->dryRun) {
            $this->createBackup();
        }
        
        // ×¢×‘×•×¨ ×¢×œ ×›×œ ×§×‘×¦×™ ×”×˜×¤×¡×™×
        foreach ($this->formFiles as $file) {
            $this->processFormFile($file);
        }
        
        // ×¡×™×›×•×
        $this->printSummary();
    }
    
    /**
     * ×¢×™×‘×•×“ ×§×•×‘×¥ ×˜×•×¤×¡ ×‘×•×“×“
     */
    private function processFormFile($filename) {
        $filepath = $this->formsPath . '/' . $filename;
        
        if (!file_exists($filepath)) {
            $this->log("âš ï¸  ×§×•×‘×¥ ×œ× × ××¦×: $filename");
            return;
        }
        
        $this->log("\nğŸ“„ ××¢×‘×“: $filename");
        
        // ×§×¨×™××ª ×”×§×•×‘×¥
        $content = file_get_contents($filepath);
        $originalContent = $content;
        
        // ×‘×™×¦×•×¢ ×ª×™×§×•× ×™×
        $content = $this->fixHeaders($content, $filename);
        $content = $this->fixParameterHandling($content, $filename);
        $content = $this->fixErrorHandling($content, $filename);
        $content = $this->fixRequirePaths($content, $filename);
        $content = $this->fixHiddenFields($content, $filename);
        $content = $this->fixModalRendering($content, $filename);
        
        // ×‘×“×™×§×” ×× ×‘×•×¦×¢×• ×©×™× ×•×™×™×
        if ($content !== $originalContent) {
            $this->fixedCount++;
            $this->log("   âœ… × ××¦××• ×•×‘×•×¦×¢×• ×ª×™×§×•× ×™×");
            
            // ×©××™×¨×” ×× ×œ× ×‘××¦×‘ dry run
            if (!$this->dryRun) {
                file_put_contents($filepath, $content);
                $this->log("   ğŸ’¾ ×”×§×•×‘×¥ ×¢×•×“×›×Ÿ");
            }
        } else {
            $this->log("   âœ“ ×”×§×•×‘×¥ ×›×‘×¨ ×ª×§×™×Ÿ");
        }
    }
    
    /**
     * ×ª×™×§×•×Ÿ Headers
     */
    private function fixHeaders($content, $filename) {
        // ×”×•×¡×£ headers ×¡×˜× ×“×¨×˜×™×™× ×× ×—×¡×¨×™×
        $standardHeaders = "<?php\n";
        $standardHeaders .= "// " . str_repeat("=", 60) . "\n";
        $standardHeaders .= "// $filename - ×˜×•×¤×¡ ××—×™×“ ×•××ª×•×§×Ÿ\n";
        $standardHeaders .= "// Generated by FormUniformityFixer v1.0\n";
        $standardHeaders .= "// " . str_repeat("=", 60) . "\n\n";
        $standardHeaders .= "// === ×”×’×“×¨×•×ª ×¡×˜× ×“×¨×˜×™×•×ª ===\n";
        $standardHeaders .= "error_reporting(E_ALL);\n";
        $standardHeaders .= "ini_set('display_errors', 1);\n";
        $standardHeaders .= "header('Content-Type: text/html; charset=utf-8');\n\n";
        
        // ×‘×“×•×§ ×× ×™×© ×›×‘×¨ headers
        if (strpos($content, "error_reporting") === false) {
            $content = str_replace("<?php", $standardHeaders, $content);
            $this->log("   + ×”×•×¡×¤×ª Headers ×¡×˜× ×“×¨×˜×™×™×");
        }
        
        return $content;
    }
    
    /**
     * ×ª×™×§×•×Ÿ ×§×‘×œ×ª ×¤×¨××˜×¨×™×
     */
    private function fixParameterHandling($content, $filename) {
        // ×”×—×œ×£ ××ª ×›×œ ×”×•×•×¨×™××¦×™×•×ª ×‘×§×•×“ ××—×™×“
        $oldPatterns = [
            '/\$itemId\s*=\s*\$_GET\[\'itemId\'\]\s*\?\?\s*\$_GET\[\'id\'\]\s*\?\?\s*null;/',
            '/\$itemId\s*=\s*\$_GET\[\'itemId\'\]\s*\?\?\s*null;/',
            '/\$itemId\s*=\s*\$_GET\[\'id\'\]\s*\?\?\s*null;/',
        ];
        
        $newCode = "\n// === ×§×‘×œ×ª ×¤×¨××˜×¨×™× ××—×™×“×” ===\n";
        $newCode .= "\$itemId = \$_GET['itemId'] ?? \$_GET['id'] ?? null;\n";
        $newCode .= "\$parentId = \$_GET['parentId'] ?? \$_GET['parent_id'] ?? null;\n";
        $newCode .= "\$formType = basename(__FILE__, '.php'); // ××–×”×” ××•×˜×•××˜×™ ×©×œ ×¡×•×’ ×”×˜×•×¤×¡\n";
        
        $replaced = false;
        foreach ($oldPatterns as $pattern) {
            if (preg_match($pattern, $content)) {
                $content = preg_replace($pattern, $newCode, $content, 1);
                $replaced = true;
                break;
            }
        }
        
        if ($replaced) {
            $this->log("   + ×ª×•×§×Ÿ ×˜×™×¤×•×œ ×‘×¤×¨××˜×¨×™×");
        }
        
        return $content;
    }
    
    /**
     * ×ª×™×§×•×Ÿ ×˜×™×¤×•×œ ×‘×©×’×™××•×ª
     */
    private function fixErrorHandling($content, $filename) {
        // ×”×—×œ×£ die ×¢× JSON ×‘×¤×•× ×§×¦×™×” ××—×™×“×”
        $pattern = '/die\s*\(\s*json_encode\s*\(\s*\[\'error\'\s*=>\s*\$e->getMessage\(\)\]\s*\)\s*\);/';
        $replacement = 'FormUtils::handleError($e);';
        
        if (preg_match($pattern, $content)) {
            $content = preg_replace($pattern, $replacement, $content);
            $this->log("   + ×ª×•×§×Ÿ ×˜×™×¤×•×œ ×‘×©×’×™××•×ª");
        }
        
        return $content;
    }
    
    /**
     * ×ª×™×§×•×Ÿ × ×ª×™×‘×™ require
     */
    private function fixRequirePaths($content, $filename) {
        // ×ª×§×Ÿ ××ª ×›×œ ×”-require_once ×œ× ×ª×™×‘ ××—×™×“
        $patterns = [
            '/require_once\s+dirname\(__DIR__\)\s*\.\s*[\'"]\/config\.php[\'"]\s*;/',
            '/require_once\s+\$_SERVER\[\'DOCUMENT_ROOT\'\]\s*\.\s*[\'"].*config\.php[\'"]\s*;/',
        ];
        
        $replacement = "require_once dirname(__DIR__) . '/config.php';";
        
        foreach ($patterns as $pattern) {
            if (preg_match($pattern, $content)) {
                $content = preg_replace($pattern, $replacement, $content);
                $this->log("   + ×ª×•×§× ×• × ×ª×™×‘×™ require");
                break;
            }
        }
        
        return $content;
    }
    
    /**
     * ×ª×™×§×•×Ÿ ×©×“×•×ª ××•×¡×ª×¨×™×
     */
    private function fixHiddenFields($content, $filename) {
        // ×•×•×“× ×©×™×© ×©×“×” unicId ××•×¡×ª×¨ ×‘×¢×¨×™×›×”
        $pattern = '/if\s*\(\$itemId\)\s*\{/';
        
        if (preg_match($pattern, $content) && 
            strpos($content, "addField('unicId'") === false) {
            
            $hiddenFieldCode = "\n// ×”×•×¡×£ ×©×“×” ××–×”×” ××•×¡×ª×¨ ×‘×¢×¨×™×›×”\n";
            $hiddenFieldCode .= "if (\$itemId && isset(\$data['unicId'])) {\n";
            $hiddenFieldCode .= "    \$formBuilder->addField('unicId', '', 'hidden', [\n";
            $hiddenFieldCode .= "        'value' => \$data['unicId']\n";
            $hiddenFieldCode .= "    ]);\n";
            $hiddenFieldCode .= "}\n";
            
            // ×”×•×¡×£ ×œ×¤× ×™ renderModal
            $content = str_replace(
                "echo \$formBuilder->renderModal();",
                $hiddenFieldCode . "\necho \$formBuilder->renderModal();",
                $content
            );
            
            $this->log("   + × ×•×¡×£ ×©×“×” unicId ××•×¡×ª×¨");
        }
        
        return $content;
    }
    
    /**
     * ×ª×™×§×•×Ÿ ×¨×™× ×“×•×¨ ××•×“×œ
     */
    private function fixModalRendering($content, $filename) {
        // ×•×•×“× ×©×›×•×œ× ××©×ª××©×™× ×‘-renderModal ×¤×©×•×˜
        $pattern = '/echo\s+\$formBuilder->render\(\);/';
        if (preg_match($pattern, $content)) {
            $content = preg_replace($pattern, 'echo $formBuilder->renderModal();', $content);
            $this->log("   + ×ª×•×§×Ÿ ×¨×™× ×“×•×¨ ×”××•×“×œ");
        }
        
        return $content;
    }
    
    /**
     * ×™×¦×™×¨×ª ×’×™×‘×•×™
     */
    private function createBackup() {
        $this->log("\nğŸ“¦ ×™×•×¦×¨ ×’×™×‘×•×™...");
        
        if (!is_dir($this->backupPath)) {
            mkdir($this->backupPath, 0755, true);
        }
        
        foreach ($this->formFiles as $file) {
            $source = $this->formsPath . '/' . $file;
            $dest = $this->backupPath . '/' . $file;
            
            if (file_exists($source)) {
                copy($source, $dest);
            }
        }
        
        $this->log("âœ… ×’×™×‘×•×™ × ×•×¦×¨ ×‘: " . $this->backupPath);
    }
    
    /**
     * ×”×“×¤×¡×ª ×¡×™×›×•×
     */
    private function printSummary() {
        $this->log("\n" . str_repeat("=", 60));
        $this->log("ğŸ“Š ×¡×™×›×•×:");
        $this->log("   â€¢ ×§×‘×¦×™× ×©× ×‘×“×§×•: " . count($this->formFiles));
        $this->log("   â€¢ ×§×‘×¦×™× ×©×ª×•×§× ×•: " . $this->fixedCount);
        
        if (count($this->errors) > 0) {
            $this->log("   â€¢ ×©×’×™××•×ª: " . count($this->errors));
            foreach ($this->errors as $error) {
                $this->log("     âŒ " . $error);
            }
        }
        
        if ($this->dryRun) {
            $this->log("\nâš ï¸  ×–×• ×”×™×™×ª×” ×”×¨×¦×ª ×‘×“×™×§×” ×‘×œ×‘×“.");
            $this->log("   ×œ×”×¨×¦×” ×××™×ª×™×ª, ×”×¨×¥ ×¢× ×¤×¨××˜×¨: fix");
        } else {
            $this->log("\nâœ… ×›×œ ×”×ª×™×§×•× ×™× ×‘×•×¦×¢×• ×‘×”×¦×œ×—×”!");
        }
        
        $this->log(str_repeat("=", 60));
    }
    
    /**
     * ×¨×™×©×•× ×”×•×“×¢×”
     */
    private function log($message) {
        echo $message . "\n";
        $this->log[] = $message;
    }
}

// === × ×§×•×“×ª ×›× ×™×¡×” ===

// ×‘×“×•×§ ×× ××¨×™×¦×™× ××”×˜×¨××™× ×œ
if (php_sapi_name() !== 'cli') {
    die("âš ï¸ ×”×¡×§×¨×™×¤×˜ ×—×™×™×‘ ×œ×¨×•×¥ ××”×˜×¨××™× ×œ ×‘×œ×‘×“!\n");
}

// ×‘×“×•×§ ×¤×¨××˜×¨×™×
$action = $argv[1] ?? 'check';

if ($action === 'fix') {
    echo "\nğŸ”§ ××ª×—×™×œ ×ª×™×§×•×Ÿ ×××™×ª×™...\n\n";
    $fixer = new FormUniformityFixer(false);
} else {
    echo "\nğŸ” ××¨×™×¥ ×‘×“×™×§×” ×‘×œ×‘×“ (Dry Run)...\n\n";
    $fixer = new FormUniformityFixer(true);
}

$fixer->run();

?>