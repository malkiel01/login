<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Debug - ×‘×“×™×§×” ××œ××” ×©×œ ××¢×¨×›×ª ×”×ª×¨××•×ª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .card h2 {
            color: #2a5298;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        /* ×¡×˜×˜×•×¡×™× */
        .status-grid {
            display: grid;
            gap: 12px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            border-right: 4px solid #ddd;
            transition: all 0.3s;
        }
        
        .status-item.active {
            border-right-color: #4CAF50;
            background: #e8f5e9;
        }
        
        .status-item.inactive {
            border-right-color: #f44336;
            background: #ffebee;
        }
        
        .status-item.partial {
            border-right-color: #FF9800;
            background: #fff3e0;
        }
        
        .status-item.checking {
            border-right-color: #2196F3;
            background: #e3f2fd;
        }
        
        .status-label {
            font-weight: 500;
            color: #333;
        }
        
        .status-value {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
        }
        
        .status-value.active { background: #4CAF50; }
        .status-value.inactive { background: #f44336; }
        .status-value.partial { background: #FF9800; }
        .status-value.checking { background: #2196F3; }
        .status-value.neutral { background: #9E9E9E; }
        
        /* ×›×¤×ª×•×¨×™× */
        .button-grid {
            display: grid;
            gap: 10px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);
            color: white;
        }
        
        /* ×§×•× ×¡×•×œ */
        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .console-entry {
            margin: 4px 0;
            padding: 4px 8px;
            border-radius: 4px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .console-info { color: #58a6ff; }
        .console-success { color: #3fb950; background: rgba(63, 185, 80, 0.1); }
        .console-error { color: #f85149; background: rgba(248, 81, 73, 0.1); }
        .console-warning { color: #d29922; background: rgba(210, 153, 34, 0.1); }
        
        /* ×”×ª×¨××•×ª ×œ×•×§××œ×™×•×ª */
        .notification-list {
            max-height: 250px;
            overflow-y: auto;
        }
        
        .notification-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-right: 3px solid #4CAF50;
        }
        
        .notification-item h4 {
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .notification-item p {
            color: #666;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .notification-item .time {
            color: #999;
            font-size: 11px;
        }
        
        /* ×× ×™××¦×™×” ×œ×‘×“×™×§×•×ª */
        .checking-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #2196F3;
            border-radius: 50%;
            animation: pulse 1s infinite;
            margin-right: 8px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        /* ×”×•×“×¢×•×ª */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* ××•× ×™× */
        .counter {
            font-size: 24px;
            font-weight: bold;
            color: #2a5298;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 8px;
        }
        
        .counter small {
            display: block;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-weight: normal;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” ××¢×¨×›×ª ×‘×“×™×§×ª ×”×ª×¨××•×ª ××œ××”</h1>
        <p>Debug Mode - ×‘×“×™×§×ª ×›×œ ×¨×›×™×‘×™ ××¢×¨×›×ª ×”×”×ª×¨××•×ª</p>
    </div>
    
    <div class="dashboard">
        <!-- ×›×¨×˜×™×¡ ×¡×˜×˜×•×¡×™× -->
        <div class="card">
            <h2>ğŸ“Š ×¡×˜×˜×•×¡ ××¢×¨×›×ª</h2>
            <div class="status-grid">
                <div class="status-item" id="browser-support-item">
                    <span class="status-label">×ª××™×›×ª ×“×¤×“×¤×Ÿ</span>
                    <span class="status-value neutral" id="browser-support">×‘×•×“×§...</span>
                </div>
                <div class="status-item" id="sw-item">
                    <span class="status-label">Service Worker</span>
                    <span class="status-value neutral" id="sw-status">×‘×•×“×§...</span>
                </div>
                <div class="status-item" id="notif-item">
                    <span class="status-label">×”×¨×©××•×ª ×”×ª×¨××•×ª</span>
                    <span class="status-value neutral" id="notif-status">×‘×•×“×§...</span>
                </div>
                <div class="status-item" id="push-item">
                    <span class="status-label">Push API</span>
                    <span class="status-value neutral" id="push-status">×‘×•×“×§...</span>
                </div>
                <div class="status-item" id="sync-item">
                    <span class="status-label">Background Sync</span>
                    <span class="status-value neutral" id="sync-status">×‘×•×“×§...</span>
                </div>
                <div class="status-item" id="periodic-item">
                    <span class="status-label">Periodic Sync</span>
                    <span class="status-value neutral" id="periodic-status">×‘×•×“×§...</span>
                </div>
                <div class="status-item" id="listener-item">
                    <span class="status-label">Push Listener</span>
                    <span class="status-value neutral" id="listener-status">×‘×•×“×§...</span>
                </div>
                <div class="status-item" id="session-item">
                    <span class="status-label">User Session</span>
                    <span class="status-value neutral" id="session-status">×‘×•×“×§...</span>
                </div>
            </div>
        </div>
        
        <!-- ×›×¨×˜×™×¡ ×”×¤×¢×œ×” -->
        <div class="card">
            <h2>ğŸš€ ×”×¤×¢×œ×ª ×¨×›×™×‘×™×</h2>
            <div class="button-grid">
                <button class="btn-primary" onclick="setupEverything()">
                    âš¡ ×”×’×“×¨×” ××•×˜×•××˜×™×ª ××œ××”
                </button>
                <button class="btn-success" onclick="registerSW()">
                    ğŸ“¦ ×¨×©×•× Service Worker
                </button>
                <button class="btn-success" onclick="requestNotif()">
                    ğŸ”” ×‘×§×© ×”×¨×©××•×ª ×”×ª×¨××•×ª
                </button>
                <button class="btn-success" onclick="setupBackgroundSync()">
                    ğŸ”„ ×”×¤×¢×œ Background Sync
                </button>
                <button class="btn-info" onclick="startPushListener()">
                    ğŸ‘‚ ×”×¤×¢×œ Push Listener
                </button>
            </div>
        </div>
        
        <!-- ×›×¨×˜×™×¡ ×‘×“×™×§×•×ª -->
        <div class="card">
            <h2>ğŸ§ª ×‘×“×™×§×•×ª</h2>
            <div class="button-grid">
                <button class="btn-warning" onclick="testNotification()">
                    ğŸ“¨ ×©×œ×— ×”×ª×¨××ª ×‘×“×™×§×”
                </button>
                <button class="btn-warning" onclick="checkUndelivered()">
                    ğŸ” ×‘×“×•×§ ×”×ª×¨××•×ª ×©×œ× × ××¡×¨×•
                </button>
                <button class="btn-warning" onclick="triggerBackgroundSync()">
                    âš¡ ×”×¤×¢×œ Background Sync ×™×“× ×™×ª
                </button>
                <button class="btn-warning" onclick="simulateOfflineNotification()">
                    ğŸ“´ ×¡××œ×¥ ×”×ª×¨××” ××•×¤×œ×™×™×Ÿ
                </button>
                <button class="btn-danger" onclick="clearAll()">
                    ğŸ—‘ï¸ × ×§×” ×”×›×œ ×•×”×ª×—×œ ××—×“×©
                </button>
            </div>
        </div>
        
        <!-- ×›×¨×˜×™×¡ ××•× ×™× -->
        <div class="card">
            <h2>ğŸ“ˆ ×¡×˜×˜×™×¡×˜×™×§×•×ª</h2>
            <div class="counter">
                <span id="notif-counter">0</span>
                <small>×”×ª×¨××•×ª ×©× ××¡×¨×• ×”×™×•×</small>
            </div>
            <div class="counter" style="margin-top: 10px;">
                <span id="unread-counter">0</span>
                <small>×”×ª×¨××•×ª ×©×œ× × ×§×¨××•</small>
            </div>
            <div class="counter" style="margin-top: 10px;">
                <span id="check-counter">0</span>
                <small>×‘×“×™×§×•×ª ×©×‘×•×¦×¢×•</small>
            </div>
        </div>
        
        <!-- ×›×¨×˜×™×¡ ×”×ª×¨××•×ª ××—×¨×•× ×•×ª -->
        <div class="card">
            <h2>ğŸ“¬ ×”×ª×¨××•×ª ××—×¨×•× ×•×ª</h2>
            <div class="notification-list" id="notification-list">
                <p style="color: #999; text-align: center;">××™×Ÿ ×”×ª×¨××•×ª ×¢×“×™×™×Ÿ</p>
            </div>
        </div>
        
        <!-- ×›×¨×˜×™×¡ ×§×•× ×¡×•×œ -->
        <div class="card" style="grid-column: 1 / -1;">
            <h2>ğŸ’» ×§×•× ×¡×•×œ</h2>
            <div class="console" id="console">
                <div class="console-entry console-info">ğŸš€ ××¢×¨×›×ª Debug × ×˜×¢× ×”...</div>
            </div>
        </div>
        
        <!-- ×”×•×“×¢×•×ª ×—×©×•×‘×•×ª -->
        <div class="card" style="grid-column: 1 / -1;">
            <h2>â„¹ï¸ ××™×“×¢ ×—×©×•×‘</h2>
            <div class="alert alert-warning">
                <strong>âš ï¸ ×“×¤×“×¤× ×™× × ×ª××›×™×:</strong> Chrome, Edge, Firefox (×—×œ×§×™×ª). Safari/iOS ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª ×¨×§×¢ ××œ××•×ª.
            </div>
            <div class="alert alert-info">
                <strong>ğŸ’¡ ×˜×™×¤:</strong> ×œ×—×¥ ×¢×œ "×”×’×“×¨×” ××•×˜×•××˜×™×ª ××œ××”" ×›×“×™ ×œ×”×’×“×™×¨ ××ª ×”×›×œ ×‘×œ×—×™×¦×” ××—×ª!
            </div>
        </div>
    </div>

    <script>
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let checkCount = 0;
        let notificationCount = 0;
        
        // ×œ×•×’ ×œ×§×•× ×¡×•×œ
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const entry = document.createElement('div');
            entry.className = `console-entry console-${type}`;
            const time = new Date().toLocaleTimeString('he-IL');
            entry.innerHTML = `<span style="opacity: 0.6">[${time}]</span> ${message}`;
            console.insertBefore(entry, console.firstChild);
            
            // ×”×’×‘×œ ×œ-100 ×©×•×¨×•×ª
            while (console.children.length > 100) {
                console.removeChild(console.lastChild);
            }
        }
        
        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡
        function updateStatus(id, status, text = null) {
            const element = document.getElementById(id);
            const item = document.getElementById(id.replace('-status', '-item'));
            
            if (element) {
                element.className = 'status-value ' + status;
                element.textContent = text || (
                    status === 'active' ? '×¤×¢×™×œ' :
                    status === 'inactive' ? '×œ× ×¤×¢×™×œ' :
                    status === 'partial' ? '×—×œ×§×™' :
                    status === 'checking' ? '×‘×•×“×§...' :
                    '×œ× × ×ª××š'
                );
            }
            
            if (item) {
                item.className = 'status-item ' + status;
            }
        }
        
        // ×‘×“×™×§×ª ×¡×˜×˜×•×¡×™×
        async function checkAllStatuses() {
            log('ğŸ” ××ª×—×™×œ ×‘×“×™×§×ª ×¡×˜×˜×•×¡×™× ××§×™×¤×”...');
            
            // ×ª××™×›×ª ×“×¤×“×¤×Ÿ
            const browser = detectBrowser();
            updateStatus('browser-support', browser.supported ? 'active' : 'inactive', browser.name);
            log(`×“×¤×“×¤×Ÿ: ${browser.name} - ${browser.supported ? '× ×ª××š' : '×œ× × ×ª××š'}`, browser.supported ? 'success' : 'warning');
            
            // Service Worker
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.getRegistration();
                updateStatus('sw-status', registration ? 'active' : 'inactive');
                if (registration) {
                    log('âœ… Service Worker ×¨×©×•× ×•×¤×¢×™×œ', 'success');
                } else {
                    log('âŒ Service Worker ×œ× ×¨×©×•×', 'error');
                }
            } else {
                updateStatus('sw-status', 'inactive', '×œ× × ×ª××š');
                log('âŒ ×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘-Service Worker', 'error');
            }
            
            // ×”×¨×©××•×ª ×”×ª×¨××•×ª
            if ('Notification' in window) {
                const perm = Notification.permission;
                updateStatus('notif-status', 
                    perm === 'granted' ? 'active' : 
                    perm === 'denied' ? 'inactive' : 'partial',
                    perm === 'granted' ? '×××•×©×¨' : 
                    perm === 'denied' ? '× ×“×—×”' : '×××ª×™×Ÿ'
                );
                log(`×”×¨×©××•×ª ×”×ª×¨××•×ª: ${perm}`, perm === 'granted' ? 'success' : 'warning');
            }
            
            // Push API
            if ('PushManager' in window) {
                try {
                    const registration = await navigator.serviceWorker.ready;
                    const subscription = await registration.pushManager.getSubscription();
                    updateStatus('push-status', subscription ? 'active' : 'partial');
                    log(subscription ? 'âœ… Push ××•×’×“×¨' : 'âš ï¸ Push ×–××™×Ÿ ××‘×œ ×œ× ××•×’×“×¨', subscription ? 'success' : 'warning');
                } catch (e) {
                    updateStatus('push-status', 'inactive');
                }
            }
            
            // Background Sync
            if ('SyncManager' in window) {
                updateStatus('sync-status', 'partial', '×–××™×Ÿ');
                log('âœ… Background Sync × ×ª××š', 'success');
            } else {
                updateStatus('sync-status', 'inactive');
                log('âŒ Background Sync ×œ× × ×ª××š', 'warning');
            }
            
            // Periodic Sync
            if ('periodicSync' in ServiceWorkerRegistration.prototype) {
                updateStatus('periodic-status', 'partial', '×–××™×Ÿ');
                log('âœ… Periodic Sync × ×ª××š', 'success');
            } else {
                updateStatus('periodic-status', 'inactive');
                log('âŒ Periodic Sync ×œ× × ×ª××š', 'warning');
            }
            
            // Push Listener
            if (window.PushListener && window.PushListener.isRunning()) {
                updateStatus('listener-status', 'active');
                log('âœ… Push Listener ×¤×¢×™×œ', 'success');
            } else {
                updateStatus('listener-status', 'inactive');
                log('âŒ Push Listener ×œ× ×¤×¢×™×œ', 'warning');
            }
            
            // User Session
            const hasSession = document.cookie.includes('PHPSESSID') || localStorage.getItem('user_id');
            updateStatus('session-status', hasSession ? 'active' : 'inactive');
            log(hasSession ? 'âœ… ××©×ª××© ××—×•×‘×¨' : 'âŒ ××©×ª××© ×œ× ××—×•×‘×¨', hasSession ? 'success' : 'warning');
            
            // ×¢×“×›×•×Ÿ ××•× ×™×
            updateCounters();
        }
        
        // ×–×™×”×•×™ ×“×¤×“×¤×Ÿ
        function detectBrowser() {
            const ua = navigator.userAgent;
            let name = 'Unknown';
            let supported = false;
            
            if (ua.includes('Chrome')) {
                name = 'Chrome';
                supported = true;
            } else if (ua.includes('Edge')) {
                name = 'Edge';
                supported = true;
            } else if (ua.includes('Firefox')) {
                name = 'Firefox';
                supported = true;
            } else if (ua.includes('Safari')) {
                name = 'Safari';
                supported = false;
            }
            
            return { name, supported };
        }
        
        // ×”×’×“×¨×” ××•×˜×•××˜×™×ª ××œ××”
        async function setupEverything() {
            log('âš¡ ××ª×—×™×œ ×”×’×“×¨×” ××•×˜×•××˜×™×ª ××œ××”...', 'info');
            
            try {
                await registerSW();
                await new Promise(r => setTimeout(r, 1000));
                
                await requestNotif();
                await new Promise(r => setTimeout(r, 1000));
                
                await setupBackgroundSync();
                await new Promise(r => setTimeout(r, 1000));
                
                await startPushListener();
                
                log('ğŸ‰ ×”×”×’×“×¨×” ×”×•×©×œ××” ×‘×”×¦×œ×—×”!', 'success');
                
                // ×¨×¢× ×Ÿ ×¡×˜×˜×•×¡×™×
                checkAllStatuses();
                
            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘×”×’×“×¨×”: ${error.message}`, 'error');
            }
        }
        
        // ×¨×™×©×•× Service Worker
        async function registerSW() {
            log('ğŸ“¦ ×¨×•×©× Service Worker...', 'info');
            
            try {
                const registration = await navigator.serviceWorker.register('/service-worker.js');
                
                await navigator.serviceWorker.ready;
                
                log('âœ… Service Worker × ×¨×©× ×‘×”×¦×œ×—×”', 'success');
                updateStatus('sw-status', 'active');
                
                return registration;
            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘×¨×™×©×•×: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // ×‘×§×©×ª ×”×¨×©××•×ª
        async function requestNotif() {
            log('ğŸ”” ××‘×§×© ×”×¨×©××•×ª ×”×ª×¨××•×ª...', 'info');
            
            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    log('âœ… ×”×¨×©××•×ª × ×™×ª× ×•', 'success');
                    updateStatus('notif-status', 'active', '×××•×©×¨');
                    
                    // ×”×¦×’ ×”×ª×¨××ª ×‘×“×™×§×”
                    if ('serviceWorker' in navigator) {
                        const registration = await navigator.serviceWorker.ready;
                        await registration.showNotification('×”×ª×¨××•×ª ××•×¤×¢×œ×•×ª! ğŸ‰', {
                            body: '×”××¢×¨×›×ª ××•×›× ×” ×œ×§×‘×œ×ª ×”×ª×¨××•×ª',
                            icon: '/pwa/icons/android/android-launchericon-192-192.png'
                        });
                    }
                } else {
                    log('âŒ ×”×¨×©××•×ª × ×“×—×•', 'error');
                    updateStatus('notif-status', 'inactive', '× ×“×—×”');
                }
            } catch (error) {
                log(`âŒ ×©×’×™××”: ${error.message}`, 'error');
            }
        }
        
        // ×”×’×“×¨×ª Background Sync
        async function setupBackgroundSync() {
            log('ğŸ”„ ××’×“×™×¨ Background Sync...', 'info');
            
            try {
                const registration = await navigator.serviceWorker.ready;
                
                if ('sync' in registration) {
                    await registration.sync.register('check-notifications');
                    log('âœ… Background Sync × ×¨×©×', 'success');
                    updateStatus('sync-status', 'active');
                }
                
                if ('periodicSync' in registration) {
                    try {
                        await registration.periodicSync.register('check-notifications', {
                            minInterval: 30 * 60 * 1000
                        });
                        log('âœ… Periodic Sync × ×¨×©×', 'success');
                        updateStatus('periodic-status', 'active');
                    } catch (e) {
                        log('âš ï¸ Periodic Sync ×“×•×¨×© ×”×¨×©××” ××™×•×—×“×ª', 'warning');
                    }
                }
            } catch (error) {
                log(`âŒ ×©×’×™××”: ${error.message}`, 'error');
            }
        }
        
        // ×”×¤×¢×œ×ª Push Listener
        function startPushListener() {
            log('ğŸ‘‚ ××¤×¢×™×œ Push Listener...', 'info');
            
            if (window.PushListener) {
                window.PushListener.start();
                log('âœ… Push Listener ×”×•×¤×¢×œ', 'success');
                updateStatus('listener-status', 'active');
            } else {
                log('âŒ Push Listener ×œ× × ××¦× - ×˜×¢×Ÿ ××ª ×”×¡×§×¨×™×¤×˜', 'error');
                
                // × ×¡×” ×œ×˜×¢×•×Ÿ
                const script = document.createElement('script');
                script.src = '/push-listener.js';
                script.onload = () => {
                    window.PushListener.start();
                    log('âœ… Push Listener × ×˜×¢×Ÿ ×•×”×•×¤×¢×œ', 'success');
                    updateStatus('listener-status', 'active');
                };
                document.head.appendChild(script);
            }
        }
        
        // ×‘×“×™×§×•×ª
        async function testNotification() {
            log('ğŸ“¨ ×©×•×œ×— ×”×ª×¨××ª ×‘×“×™×§×”...', 'info');
            notificationCount++;
            
            try {
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.ready;
                    await registration.showNotification(`×”×ª×¨××ª ×‘×“×™×§×” #${notificationCount}`, {
                        body: `×–×• ×”×ª×¨××” ×œ×‘×“×™×§×” - ${new Date().toLocaleTimeString('he-IL')}`,
                        icon: '/pwa/icons/android/android-launchericon-192-192.png',
                        tag: 'test-' + Date.now()
                    });
                    log('âœ… ×”×ª×¨××” × ×©×œ×—×”', 'success');
                    
                    // ×”×•×¡×£ ×œ×”×ª×¨××•×ª ××§×•××™×•×ª
                    addLocalNotification(`×”×ª×¨××ª ×‘×“×™×§×” #${notificationCount}`, `×–×• ×”×ª×¨××” ×œ×‘×“×™×§×”`);
                }
            } catch (error) {
                log(`âŒ ×©×’×™××”: ${error.message}`, 'error');
            }
            
            updateCounters();
        }
        
        async function checkUndelivered() {
            log('ğŸ” ×‘×•×“×§ ×”×ª×¨××•×ª ×©×œ× × ××¡×¨×•...', 'info');
            checkCount++;
            
            try {
                const response = await fetch('/api/notifications.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: new URLSearchParams({
                        action: 'check_undelivered'
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.notifications) {
                    log(`ğŸ“¬ × ××¦××• ${data.notifications.length} ×”×ª×¨××•×ª`, 'success');
                    
                    data.notifications.forEach(notif => {
                        addLocalNotification(notif.title, notif.body);
                    });
                } else {
                    log('âœ… ××™×Ÿ ×”×ª×¨××•×ª ×—×“×©×•×ª', 'info');
                }
            } catch (error) {
                log(`âŒ ×©×’×™××”: ${error.message}`, 'error');
            }
            
            updateCounters();
        }
        
        async function triggerBackgroundSync() {
            log('âš¡ ××¤×¢×™×œ Background Sync ×™×“× ×™×ª...', 'info');
            
            try {
                const registration = await navigator.serviceWorker.ready;
                
                if (registration.active) {
                    registration.active.postMessage({
                        type: 'CHECK_NOTIFICATIONS'
                    });
                    log('âœ… ×‘×§×©×” × ×©×œ×—×” ×œ-Service Worker', 'success');
                }
                
                if ('sync' in registration) {
                    await registration.sync.register('check-notifications');
                    log('âœ… Background Sync ×”×•×¤×¢×œ', 'success');
                }
            } catch (error) {
                log(`âŒ ×©×’×™××”: ${error.message}`, 'error');
            }
        }
        
        function simulateOfflineNotification() {
            log('ğŸ“´ ××“××” ×”×ª×¨××” ××•×¤×œ×™×™×Ÿ...', 'info');
            
            // ×©××•×¨ ×”×ª×¨××” ×‘-localStorage
            const notification = {
                id: Date.now().toString(),
                title: '×”×ª×¨××” ××•×¤×œ×™×™×Ÿ',
                body: '×”×ª×¨××” ×–×• × ×©××¨×” ×‘×–××Ÿ ××•×¤×œ×™×™×Ÿ',
                timestamp: Date.now(),
                read: false
            };
            
            let notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            notifications.unshift(notification);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            log('âœ… ×”×ª×¨××” × ×©××¨×” ×‘-localStorage', 'success');
            
            // ×”×¦×’ ×‘×××©×§
            addLocalNotification(notification.title, notification.body);
            updateCounters();
        }
        
        async function clearAll() {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×—? ×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”×”×’×“×¨×•×ª')) return;
            
            log('ğŸ—‘ï¸ ×× ×§×” ×”×›×œ...', 'warning');
            
            try {
                // ×¢×¦×•×¨ Push Listener
                if (window.PushListener) {
                    window.PushListener.stop();
                }
                
                // ××—×§ Service Worker
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let registration of registrations) {
                    await registration.unregister();
                }
                
                // × ×§×” localStorage
                localStorage.removeItem('notifications');
                
                // × ×§×” ×”×ª×¨××•×ª
                document.getElementById('notification-list').innerHTML = '<p style="color: #999; text-align: center;">××™×Ÿ ×”×ª×¨××•×ª ×¢×“×™×™×Ÿ</p>';
                
                log('âœ… ×”×›×œ × ×•×§×”', 'success');
                
                // ×¨×¢× ×Ÿ ×¡×˜×˜×•×¡×™×
                setTimeout(checkAllStatuses, 500);
                
            } catch (error) {
                log(`âŒ ×©×’×™××”: ${error.message}`, 'error');
            }
        }
        
        // ×”×•×¡×¤×ª ×”×ª×¨××” ××§×•××™×ª
        function addLocalNotification(title, body) {
            const list = document.getElementById('notification-list');
            
            // ×× ×–×• ×”×”×ª×¨××” ×”×¨××©×•× ×”, × ×§×” ××ª ×”×”×•×“×¢×”
            if (list.querySelector('p')) {
                list.innerHTML = '';
            }
            
            const item = document.createElement('div');
            item.className = 'notification-item';
            item.innerHTML = `
                <h4>${title}</h4>
                <p>${body}</p>
                <div class="time">${new Date().toLocaleString('he-IL')}</div>
            `;
            
            list.insertBefore(item, list.firstChild);
            
            // ×”×’×‘×œ ×œ-10 ×”×ª×¨××•×ª
            while (list.children.length > 10) {
                list.removeChild(list.lastChild);
            }
        }
        
        // ×¢×“×›×•×Ÿ ××•× ×™×
        function updateCounters() {
            document.getElementById('notif-counter').textContent = notificationCount;
            document.getElementById('check-counter').textContent = checkCount;
            
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const unreadCount = notifications.filter(n => !n.read).length;
            document.getElementById('unread-counter').textContent = unreadCount;
        }
        
        // ×˜×¢×™× ×” ×¨××©×•× ×™×ª
        window.addEventListener('load', () => {
            log('ğŸš€ ××¢×¨×›×ª Debug ××•×›× ×”', 'success');
            checkAllStatuses();
            
            // ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×›×œ 30 ×©× ×™×•×ª
            setInterval(checkAllStatuses, 30000);
        });
    </script>
</body>
</html>