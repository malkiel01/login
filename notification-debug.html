<!-- notification-debug.html - ××¢×¨×›×ª ×“×™×‘××’ ××§×™×¤×” ×œ×”×ª×¨××•×ª -->
<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Panel - ××¢×¨×›×ª ×”×ª×¨××•×ª</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- ×¤×× ×œ ×“×™×‘××’ ××©×•×¤×¨ -->
    <div id="debug-panel" style="position: fixed; bottom: 10px; right: 10px; background: white; 
        border: 2px solid #667eea; border-radius: 10px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
        z-index: 9999; direction: rtl; font-size: 12px; width: 350px; max-height: 600px; display: flex; flex-direction: column;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4 style="margin: 0; color: #667eea;">ğŸ”§ ×¤×× ×œ ×“×™×‘××’ ×”×ª×¨××•×ª</h4>
            <button onclick="toggleDebugPanel()" style="background: transparent; border: none; cursor: pointer; font-size: 16px;">
                <i class="fas fa-minus"></i>
            </button>
        </div>
        
        <!-- ××™×“×¢ ××©×ª××© -->
        <div style="background: #f0f8ff; padding: 8px; border-radius: 5px; margin-bottom: 10px;">
            <strong>××©×ª××©:</strong> <span id="user-email">×œ× ××—×•×‘×¨</span><br>
            <strong>×¡×˜×˜×•×¡:</strong> <span id="connection-status">ğŸ”´ ×× ×•×ª×§</span><br>
            <strong>×”×¨×©××•×ª:</strong> <span id="permission-status">×‘×•×“×§...</span>
        </div>
        
        <!-- ×›×¤×ª×•×¨×™ ×‘×“×™×§×” -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px;">
            <button onclick="testPermissions()" style="background: #667eea; color: white; border: none; 
                    padding: 8px; border-radius: 5px; cursor: pointer; font-size: 11px;">
                <i class="fas fa-key"></i> ×”×¨×©××•×ª
            </button>
            
            <button onclick="testLocalNotification()" style="background: #28a745; color: white; border: none; 
                    padding: 8px; border-radius: 5px; cursor: pointer; font-size: 11px;">
                <i class="fas fa-bell"></i> ×”×ª×¨××” ××§×•××™×ª
            </button>
            
            <button onclick="testServerConnection()" style="background: #ffc107; color: black; border: none; 
                    padding: 8px; border-radius: 5px; cursor: pointer; font-size: 11px;">
                <i class="fas fa-server"></i> ×‘×“×•×§ ×©×¨×ª
            </button>
            
            <button onclick="checkPendingNotifications()" style="background: #17a2b8; color: white; border: none; 
                    padding: 8px; border-radius: 5px; cursor: pointer; font-size: 11px;">
                <i class="fas fa-inbox"></i> ×”×ª×¨××•×ª ×××ª×™× ×•×ª
            </button>
            
            <button onclick="testPushAPI()" style="background: #6f42c1; color: white; border: none; 
                    padding: 8px; border-radius: 5px; cursor: pointer; font-size: 11px;">
                <i class="fas fa-rocket"></i> Push API
            </button>
            
            <button onclick="clearDebugLog()" style="background: #dc3545; color: white; border: none; 
                    padding: 8px; border-radius: 5px; cursor: pointer; font-size: 11px;">
                <i class="fas fa-trash"></i> × ×§×” ×œ×•×’
            </button>
        </div>
        
        <!-- ××•× ×” ×”×ª×¨××•×ª -->
        <div style="background: #e9ecef; padding: 8px; border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: space-around;">
            <div style="text-align: center;">
                <div style="font-size: 20px; font-weight: bold; color: #28a745;" id="success-count">0</div>
                <div style="font-size: 10px;">×”×¦×œ×™×—×•</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 20px; font-weight: bold; color: #ffc107;" id="pending-count">0</div>
                <div style="font-size: 10px;">×××ª×™× ×•×ª</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 20px; font-weight: bold; color: #dc3545;" id="failed-count">0</div>
                <div style="font-size: 10px;">× ×›×©×œ×•</div>
            </div>
        </div>
        
        <!-- ×œ×•×’ ××¤×•×¨×˜ -->
        <div id="debug-output" style="background: #1e1e1e; color: #00ff00; border-radius: 5px; padding: 10px; 
            font-family: 'Courier New', monospace; font-size: 11px; flex: 1; overflow-y: auto; min-height: 200px;">
            <div style="color: #ffff00;">ğŸš€ ××¢×¨×›×ª ×“×™×‘××’ ×¤×¢×™×œ×”...</div>
        </div>
        
        <!-- ×¤×¢×•×œ×•×ª × ×•×¡×¤×•×ª -->
        <div style="margin-top: 10px; display: flex; gap: 5px;">
            <button onclick="exportDebugLog()" style="background: #6c757d; color: white; border: none; 
                    padding: 5px 10px; border-radius: 5px; font-size: 10px; cursor: pointer;">
                <i class="fas fa-download"></i> ×™×™×¦× ×œ×•×’
            </button>
            <button onclick="toggleAutoRefresh()" style="background: #20c997; color: white; border: none; 
                    padding: 5px 10px; border-radius: 5px; font-size: 10px; cursor: pointer;">
                <i class="fas fa-sync"></i> <span id="auto-refresh-btn">×¨×¢× ×•×Ÿ ××•×˜×•××˜×™: ×›×‘×•×™</span>
            </button>
            <button onclick="document.getElementById('debug-panel').style.display='none'" 
                    style="background: #dc3545; color: white; border: none; 
                    padding: 5px 10px; border-radius: 5px; font-size: 10px; cursor: pointer;">
                <i class="fas fa-times"></i> ×¡×’×•×¨
            </button>
        </div>
    </div>

    <!-- ××™× ×™ ×¤×× ×œ ×›×©××•×§×˜×Ÿ -->
    <div id="mini-debug" style="position: fixed; bottom: 10px; right: 10px; background: #667eea; 
        border-radius: 50%; width: 50px; height: 50px; display: none; align-items: center; 
        justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 9999;"
        onclick="toggleDebugPanel()">
        <i class="fas fa-bug" style="color: white; font-size: 20px;"></i>
        <span id="mini-badge" style="position: absolute; top: -5px; right: -5px; background: #dc3545; 
            color: white; border-radius: 50%; width: 20px; height: 20px; display: none; 
            align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">0</span>
    </div>

    <script>
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let debugHistory = [];
        let notificationCounts = { success: 0, pending: 0, failed: 0 };
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        let userEmail = sessionStorage.getItem('userEmail') || '×œ× ××—×•×‘×¨';
        let notificationListener = null;

        // ××ª×—×•×œ
        window.addEventListener('DOMContentLoaded', () => {
            initDebugPanel();
            startNotificationListener();
            checkInitialStatus();
        });

        // ××ª×—×•×œ ×¤×× ×œ
        function initDebugPanel() {
            // ×§×‘×œ ××™×“×¢ ××©×ª××©
            fetch('/login/api/simple-notifications.php?action=get-user-info', { credentials: 'include' })
                .then(r => r.json())
                .then(data => {
                    if (data.email) {
                        userEmail = data.email;
                        document.getElementById('user-email').textContent = userEmail;
                        debugLog(`ğŸ‘¤ ××©×ª××©: ${userEmail}`, 'info');
                    }
                })
                .catch(err => debugLog('âŒ ×©×’×™××” ×‘×§×‘×œ×ª ××™×“×¢ ××©×ª××©', 'error'));

            // ×‘×“×•×§ ×”×¨×©××•×ª
            updatePermissionStatus();
            
            // ×‘×“×•×§ Service Worker
            checkServiceWorker();
        }

        // ×‘×“×™×§×ª ×¡×˜×˜×•×¡ ×¨××©×•× ×™
        function checkInitialStatus() {
            debugLog('ğŸ” ×‘×•×“×§ ×¡×˜×˜×•×¡ ××¢×¨×›×ª...', 'system');
            
            // ×‘×“×•×§ ×ª××™×›×”
            const checks = {
                'Notification API': 'Notification' in window,
                'Service Worker': 'serviceWorker' in navigator,
                'Push Manager': 'PushManager' in window,
                'Promise': 'Promise' in window
            };

            Object.entries(checks).forEach(([feature, supported]) => {
                debugLog(`${supported ? 'âœ…' : 'âŒ'} ${feature}`, supported ? 'success' : 'error');
            });

            // ×‘×“×•×§ ×—×™×‘×•×¨
            updateConnectionStatus(navigator.onLine);
            
            window.addEventListener('online', () => {
                updateConnectionStatus(true);
                debugLog('ğŸŒ ×—×–×¨× ×• ×œ××•× ×œ×™×™×Ÿ!', 'success');
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus(false);
                debugLog('ğŸ“µ ××™×Ÿ ×—×™×‘×•×¨ ×œ×¨×©×ª', 'error');
            });
        }

        // ×”××–× ×” ×œ×”×ª×¨××•×ª
        function startNotificationListener() {
            debugLog('ğŸ‘‚ ××ª×—×™×œ ×”××–× ×” ×œ×”×ª×¨××•×ª...', 'system');
            
            // ×”××–× ×” ×œ-Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.addEventListener('message', (event) => {
                    debugLog(`ğŸ“¨ ×”×•×“×¢×” ×-SW: ${JSON.stringify(event.data)}`, 'notification');
                    handleIncomingNotification(event.data);
                });
            }

            // ×”××–× ×” ×œ-Notification API
            if ('Notification' in window) {
                // ××™×Ÿ ××™×¨×•×¢ ×™×©×™×¨, ××‘×œ × ×•×›×œ ×œ×‘×“×•×§ ×“×¨×š Permission
                setInterval(() => {
                    updatePermissionStatus();
                }, 5000);
            }

            // ×¤×•×œ×™× ×’ ×œ×©×¨×ª
            startServerPolling();
        }

        // ×¤×•×œ×™× ×’ ×œ×©×¨×ª
        function startServerPolling() {
            // ×‘×“×•×§ ×›×œ 10 ×©× ×™×•×ª
            setInterval(() => {
                if (document.visibilityState === 'visible') {
                    checkPendingNotifications(true); // silent mode
                }
            }, 10000);
        }

        // ×˜×™×¤×•×œ ×‘×”×ª×¨××” × ×›× ×¡×ª
        function handleIncomingNotification(data) {
            const timestamp = new Date().toLocaleTimeString('he-IL');
            debugLog(`ğŸ”” [${timestamp}] ×”×ª×¨××” ×—×“×©×”:`, 'notification');
            debugLog(`   ×›×•×ª×¨×ª: ${data.title || '×œ×œ×'}`, 'notification');
            debugLog(`   ×ª×•×›×Ÿ: ${data.body || '×œ×œ×'}`, 'notification');
            debugLog(`   ×¡×•×’: ${data.type || '×›×œ×œ×™'}`, 'notification');
            
            if (data.email === userEmail || data.to === userEmail) {
                debugLog(`   âœ… ×”×ª×¨××” ×œ××©×ª××© ×”× ×•×›×—×™!`, 'success');
                notificationCounts.success++;
            } else {
                debugLog(`   âš ï¸ ×”×ª×¨××” ×œ××©×ª××© ××—×¨: ${data.email || data.to}`, 'warning');
            }
            
            updateCounters();
            updateMiniBadge();
        }

        // ×‘×“×™×§×ª ×”×¨×©××•×ª
        async function testPermissions() {
            debugLog('ğŸ” ×‘×•×“×§ ×”×¨×©××•×ª...', 'system');
            
            if (!('Notification' in window)) {
                debugLog('âŒ ×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª', 'error');
                return;
            }
            
            const permission = Notification.permission;
            debugLog(`ğŸ“‹ ×”×¨×©××” × ×•×›×—×™×ª: ${permission}`, permission === 'granted' ? 'success' : 'warning');
            
            if (permission === 'default') {
                debugLog('ğŸ“ ××‘×§×© ×”×¨×©××”...', 'info');
                try {
                    const result = await Notification.requestPermission();
                    debugLog(`âœ… ×ª×©×•×‘×”: ${result}`, result === 'granted' ? 'success' : 'error');
                    updatePermissionStatus();
                } catch (err) {
                    debugLog(`âŒ ×©×’×™××”: ${err.message}`, 'error');
                }
            }
        }

        // ×”×ª×¨××” ××§×•××™×ª
        async function testLocalNotification2() {
            debugLog('ğŸ”” ×©×•×œ×— ×”×ª×¨××” ××§×•××™×ª...', 'system');
            
            if (Notification.permission !== 'granted') {
                debugLog('âš ï¸ ××™×Ÿ ×”×¨×©××” - ××‘×§×©...', 'warning');
                await testPermissions();
                if (Notification.permission !== 'granted') return;
            }
            
            try {
                const timestamp = new Date().toLocaleTimeString('he-IL');
                const notification = new Notification('×‘×“×™×§×” ğŸ””', {
                    body: `×”×ª×¨××ª ×‘×“×™×§×” - ${timestamp}`,
                    icon: '/login/images/icons/android/android-launchericon-192-192.png',
                    badge: '/login/images/icons/android/android-launchericon-96-96.png',
                    tag: 'test-' + Date.now(),
                    requireInteraction: false,
                    dir: 'rtl',
                    lang: 'he'
                });
                
                notification.onclick = () => {
                    debugLog('ğŸ‘† ×”×ª×¨××” × ×œ×—×¦×”!', 'success');
                    notification.close();
                };
                
                debugLog('âœ… ×”×ª×¨××” × ×©×œ×—×” ×‘×”×¦×œ×—×”!', 'success');
                notificationCounts.success++;
                updateCounters();
                
                // ×¡×’×•×¨ ××—×¨×™ 5 ×©× ×™×•×ª
                setTimeout(() => notification.close(), 5000);
                
            } catch (err) {
                debugLog(`âŒ ×©×’×™××”: ${err.message}`, 'error');
                notificationCounts.failed++;
                updateCounters();
            }
        }


        // ×”×ª×¨××” ××§×•××™×ª - ×’×¨×¡×” ××ª×•×§× ×ª ×œ-HTTPS
        async function testLocalNotification() {
            debugLog('ğŸ”” ×©×•×œ×— ×”×ª×¨××” ××§×•××™×ª...', 'system');
            
            // ×‘×“×•×§ ×”×¨×©××•×ª
            if (Notification.permission !== 'granted') {
                debugLog('âš ï¸ ××™×Ÿ ×”×¨×©××” - ××‘×§×©...', 'warning');
                await testPermissions();
                if (Notification.permission !== 'granted') return;
            }
            
            try {
                // ×‘-HTTPS ×—×™×™×‘×™× ×œ×”×©×ª××© ×‘-Service Worker
                if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
                    debugLog('ğŸ”’ HTTPS detected - using Service Worker', 'info');
                    
                    const registration = await navigator.serviceWorker.ready;
                    const timestamp = new Date().toLocaleTimeString('he-IL');
                    
                    await registration.showNotification('×‘×“×™×§×” ğŸ””', {
                        body: `×”×ª×¨××ª ×‘×“×™×§×” - ${timestamp}`,
                        icon: '/login/images/icons/android/android-launchericon-192-192.png',
                        badge: '/login/images/icons/android/android-launchericon-96-96.png',
                        tag: 'test-' + Date.now(),
                        requireInteraction: false,
                        vibrate: [200, 100, 200],
                        dir: 'rtl',
                        lang: 'he',
                        silent: false,
                        data: {
                            type: 'test',
                            timestamp: timestamp
                        }
                    });
                    
                    debugLog('âœ… ×”×ª×¨××” × ×©×œ×—×” ×‘×”×¦×œ×—×” ×“×¨×š Service Worker!', 'success');
                    notificationCounts.success++;
                    updateCounters();
                    
                } else if (window.location.protocol === 'http:') {
                    // ×¨×§ ×‘-HTTP ××¤×©×¨ ×œ×”×©×ª××© ×‘-Notification API ×¨×’×™×œ
                    debugLog('ğŸ”“ HTTP detected - using standard Notification API', 'info');
                    
                    const timestamp = new Date().toLocaleTimeString('he-IL');
                    const notification = new Notification('×‘×“×™×§×” ğŸ””', {
                        body: `×”×ª×¨××ª ×‘×“×™×§×” - ${timestamp}`,
                        icon: '/login/images/icons/android/android-launchericon-192-192.png',
                        tag: 'test-' + Date.now(),
                        dir: 'rtl',
                        lang: 'he'
                    });
                    
                    notification.onclick = () => {
                        debugLog('ğŸ‘† ×”×ª×¨××” × ×œ×—×¦×”!', 'success');
                        notification.close();
                    };
                    
                    debugLog('âœ… ×”×ª×¨××” × ×©×œ×—×” ×‘×”×¦×œ×—×”!', 'success');
                    notificationCounts.success++;
                    updateCounters();
                    
                    setTimeout(() => notification.close(), 5000);
                    
                } else {
                    debugLog('âŒ ×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— ×”×ª×¨××” ×‘×¡×‘×™×‘×” ×”× ×•×›×—×™×ª', 'error');
                }
                
            } catch (err) {
                debugLog(`âŒ ×©×’×™××”: ${err.message}`, 'error');
                notificationCounts.failed++;
                updateCounters();
                
                // × ×¡×” fallback ×œ×‘×× ×¨ ×‘×“×£
                debugLog('ğŸ“‹ ×× ×¡×” ×‘×× ×¨ ×—×œ×•×¤×™...', 'info');
                showInPageNotification('×‘×“×™×§×” ğŸ””', '×”×ª×¨××ª ×‘×“×™×§×” - ' + new Date().toLocaleTimeString('he-IL'));
            }
        }

        // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×‘×× ×¨ ×‘×“×£
        function showInPageNotification(title, body) {
            const banner = document.createElement('div');
            banner.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: white;
                border: 2px solid #667eea;
                border-radius: 10px;
                padding: 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideDown 0.5s ease;
                direction: rtl;
                min-width: 300px;
            `;
            
            banner.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 30px;">ğŸ””</div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 5px 0; color: #667eea;">${title}</h4>
                        <p style="margin: 0; color: #666; font-size: 14px;">${body}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 20px; 
                                color: #999; cursor: pointer;">Ã—</button>
                </div>
            `;
            
            document.body.appendChild(banner);
            
            // ×”×•×¡×£ ×× ×™××¦×™×”
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideDown {
                    from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
                    to { transform: translateX(-50%) translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            debugLog('âœ… ×‘×× ×¨ ×”×•×¦×’ ×‘×”×¦×œ×—×”', 'success');
            
            // ×”×¡×¨ ××—×¨×™ 5 ×©× ×™×•×ª
            setTimeout(() => banner.remove(), 5000);
        }

// ----

        // ×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ×©×¨×ª
        async function testServerConnection() {
            debugLog('ğŸŒ ×‘×•×“×§ ×—×™×‘×•×¨ ×œ×©×¨×ª...', 'system');
            
            try {
                const response = await fetch('/login/api/simple-notifications.php?action=test', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    debugLog(`âœ… ×”×©×¨×ª ××’×™×‘: ${JSON.stringify(data)}`, 'success');
                    updateConnectionStatus(true);
                } else {
                    debugLog(`âŒ ×©×’×™××ª ×©×¨×ª: ${response.status}`, 'error');
                    updateConnectionStatus(false);
                }
            } catch (err) {
                debugLog(`âŒ ××™×Ÿ ×—×™×‘×•×¨: ${err.message}`, 'error');
                updateConnectionStatus(false);
            }
        }

        // ×‘×“×™×§×ª ×”×ª×¨××•×ª ×××ª×™× ×•×ª
        async function checkPendingNotifications(silent = false) {
            if (!silent) debugLog('ğŸ“¥ ×‘×•×“×§ ×”×ª×¨××•×ª ×××ª×™× ×•×ª...', 'system');
            
            try {
                const response = await fetch('/login/api/simple-notifications.php?action=get-pending', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.notifications && data.notifications.length > 0) {
                        debugLog(`ğŸ“¬ × ××¦××• ${data.notifications.length} ×”×ª×¨××•×ª:`, 'notification');
                        data.notifications.forEach((n, i) => {
                            debugLog(`  ${i+1}. ${n.title || '×œ×œ× ×›×•×ª×¨×ª'}`, 'notification');
                            handleIncomingNotification(n);
                        });
                        notificationCounts.pending = data.notifications.length;
                    } else if (!silent) {
                        debugLog('ğŸ“­ ××™×Ÿ ×”×ª×¨××•×ª ×××ª×™× ×•×ª', 'info');
                    }
                    updateCounters();
                } else if (!silent) {
                    debugLog(`âš ï¸ ×ª×’×•×‘×ª ×©×¨×ª: ${response.status}`, 'warning');
                }
            } catch (err) {
                if (!silent) debugLog(`âŒ ×©×’×™××”: ${err.message}`, 'error');
            }
        }

        // ×‘×“×™×§×ª Push API
        async function testPushAPI() {
            debugLog('ğŸš€ ×‘×•×“×§ Push API...', 'system');
            
            if (!('PushManager' in window)) {
                debugLog('âŒ ××™×Ÿ ×ª××™×›×” ×‘-Push API', 'error');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.ready;
                debugLog('âœ… Service Worker ××•×›×Ÿ', 'success');
                
                const subscription = await registration.pushManager.getSubscription();
                if (subscription) {
                    debugLog('ğŸ“± ×™×© ×× ×•×™ ×¤×¢×™×œ:', 'success');
                    debugLog(`   Endpoint: ${subscription.endpoint.substr(0, 50)}...`, 'info');
                } else {
                    debugLog('ğŸ“µ ××™×Ÿ ×× ×•×™ ×¤×¢×™×œ', 'warning');
                    
                    // × ×¡×” ×œ×™×¦×•×¨ ×× ×•×™
                    debugLog('ğŸ“ ×× ×¡×” ×œ×™×¦×•×¨ ×× ×•×™ ×—×“×©...', 'info');
                    try {
                        const newSub = await registration.pushManager.subscribe({
                            userVisibleOnly: true
                        });
                        debugLog('âœ… ×× ×•×™ × ×•×¦×¨ ×‘×”×¦×œ×—×”!', 'success');
                    } catch (err) {
                        debugLog(`âŒ ×›×©×œ×•×Ÿ ×‘×™×¦×™×¨×ª ×× ×•×™: ${err.message}`, 'error');
                    }
                }
            } catch (err) {
                debugLog(`âŒ ×©×’×™××”: ${err.message}`, 'error');
            }
        }

        // ×‘×“×™×§×ª Service Worker
        async function checkServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                debugLog('âŒ ××™×Ÿ ×ª××™×›×” ×‘-Service Worker', 'error');
                return;
            }
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                if (registrations.length > 0) {
                    debugLog(`âœ… Service Worker ×¨×©×•×: ${registrations.length} instances`, 'success');
                    registrations.forEach((reg, i) => {
                        debugLog(`   ${i+1}. Scope: ${reg.scope}`, 'info');
                    });
                } else {
                    debugLog('âš ï¸ ××™×Ÿ Service Worker ×¨×©×•×', 'warning');
                }
            } catch (err) {
                debugLog(`âŒ ×©×’×™××ª SW: ${err.message}`, 'error');
            }
        }

        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”×¨×©××•×ª
        function updatePermissionStatus() {
            if ('Notification' in window) {
                const permission = Notification.permission;
                const statusEl = document.getElementById('permission-status');
                
                if (permission === 'granted') {
                    statusEl.innerHTML = '<span style="color: green;">âœ… ×××•×©×¨</span>';
                } else if (permission === 'denied') {
                    statusEl.innerHTML = '<span style="color: red;">âŒ × ×“×—×”</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: orange;">â³ ×××ª×™×Ÿ</span>';
                }
            }
        }

        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×—×™×‘×•×¨
        function updateConnectionStatus(isOnline) {
            const statusEl = document.getElementById('connection-status');
            if (isOnline) {
                statusEl.innerHTML = 'ğŸŸ¢ ××—×•×‘×¨';
            } else {
                statusEl.innerHTML = 'ğŸ”´ ×× ×•×ª×§';
            }
        }

        // ×¢×“×›×•×Ÿ ××•× ×™×
        function updateCounters() {
            document.getElementById('success-count').textContent = notificationCounts.success;
            document.getElementById('pending-count').textContent = notificationCounts.pending;
            document.getElementById('failed-count').textContent = notificationCounts.failed;
        }

        // ×¢×“×›×•×Ÿ ×ª×’ ××™× ×™
        function updateMiniBadge() {
            const total = notificationCounts.success + notificationCounts.pending;
            const badge = document.getElementById('mini-badge');
            if (total > 0) {
                badge.textContent = total;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // ×›×ª×™×‘×” ×œ×œ×•×’
        function debugLog(msg, type = 'info') {
            const output = document.getElementById('debug-output');
            const time = new Date().toLocaleTimeString('he-IL');
            
            // ×¦×‘×¢×™× ×œ×¤×™ ×¡×•×’
            const colors = {
                'info': '#00ff00',
                'warning': '#ffff00',
                'error': '#ff0000',
                'success': '#00ff00',
                'notification': '#00ffff',
                'system': '#ff00ff'
            };
            
            const color = colors[type] || '#ffffff';
            const entry = `<div style="color: ${color}; margin: 2px 0;">[${time}] ${msg}</div>`;
            
            output.innerHTML = entry + output.innerHTML;
            
            // ×©××•×¨ ×‘×”×™×¡×˜×•×¨×™×”
            debugHistory.push({ time, msg, type });
            
            // ×”×’×‘×œ ×œ-100 ×©×•×¨×•×ª
            const lines = output.querySelectorAll('div');
            if (lines.length > 100) {
                lines[lines.length - 1].remove();
            }
        }

        // × ×™×§×•×™ ×œ×•×’
        function clearDebugLog() {
            document.getElementById('debug-output').innerHTML = '<div style="color: #ffff00;">ğŸš€ ×œ×•×’ × ×•×§×”...</div>';
            debugHistory = [];
            notificationCounts = { success: 0, pending: 0, failed: 0 };
            updateCounters();
            updateMiniBadge();
        }

        // ×™×™×¦×•× ×œ×•×’
        function exportDebugLog() {
            const content = debugHistory.map(entry => 
                `[${entry.time}] [${entry.type.toUpperCase()}] ${entry.msg}`
            ).join('\n');
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `notification-debug-${new Date().toISOString()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            debugLog('ğŸ“ ×œ×•×’ ×™×•×¦× ×œ×§×•×‘×¥', 'success');
        }

        // ×”×—×œ×¤×ª ××¦×‘ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™
        function toggleAutoRefresh() {
            isAutoRefresh = !isAutoRefresh;
            const btn = document.getElementById('auto-refresh-btn');
            
            if (isAutoRefresh) {
                btn.textContent = '×¨×¢× ×•×Ÿ ××•×˜×•××˜×™: ×¤×¢×™×œ';
                autoRefreshInterval = setInterval(() => {
                    checkPendingNotifications(true);
                }, 5000);
                debugLog('ğŸ”„ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×”×•×¤×¢×œ', 'success');
            } else {
                btn.textContent = '×¨×¢× ×•×Ÿ ××•×˜×•××˜×™: ×›×‘×•×™';
                clearInterval(autoRefreshInterval);
                debugLog('â¸ï¸ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×”×•×¤×¡×§', 'info');
            }
        }

        // ×”×—×œ×¤×ª ×ª×¦×•×’×ª ×¤×× ×œ
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            const mini = document.getElementById('mini-debug');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                mini.style.display = 'none';
            } else {
                panel.style.display = 'none';
                mini.style.display = 'flex';
            }
        }

        // ×”×•×¡×£ ×¤×•× ×§×¦×™×” ×’×œ×•×‘×œ×™×ª ×œ×§×‘×œ×ª ×”×ª×¨××•×ª
        window.debugNotification = function(title, body, data = {}) {
            handleIncomingNotification({
                title,
                body,
                ...data,
                email: userEmail
            });
        };
    </script>

    <!-- ×“×•×’××” ×œ×©×™××•×© -->
    <div style="padding: 100px; text-align: center;">
        <h1>×“×£ ×‘×“×™×§×ª ×”×ª×¨××•×ª</h1>
        <p>×¤×× ×œ ×”×“×™×‘××’ × ××¦× ×‘×¤×™× ×” ×”×™×× ×™×ª ×”×ª×—×ª×•× ×”</p>
        
        <button onclick="debugNotification('×”×ª×¨××” ×™×“× ×™×ª', '×–×• ×”×ª×¨××” ×©× ×©×œ×—×” ×™×“× ×™×ª', {type: 'test'})" 
                style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
            ×©×œ×— ×”×ª×¨××” ×™×“× ×™×ª
        </button>
    </div>
</body>
</html>