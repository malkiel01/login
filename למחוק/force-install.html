<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דיבוג התקנת PWA</title>
    <link rel="manifest" href="/login/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="קניות מרוכזות">
    <link rel="apple-touch-icon" href="/login/images/icons/icon-192x192.png">
    <style>
        body {
            font-family: monospace;
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        .debug-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .check-item {
            background: #2a2a2a;
            border: 1px solid #444;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { border-left: 5px solid #00ff00; }
        .error { border-left: 5px solid #ff0000; }
        .warning { border-left: 5px solid #ffaa00; }
        .info { border-left: 5px solid #00aaff; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover { background: #45a049; }
        #install-btn {
            background: #ff9800;
            font-size: 20px;
            padding: 15px 30px;
        }
        pre {
            background: #000;
            padding: 10px;
            overflow-x: auto;
            border-radius: 5px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
        }
        .log-error { color: #ff6b6b; }
        .log-warn { color: #ffd93d; }
        .log-success { color: #6bcf7f; }
        .log-info { color: #4dabf7; }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>🔍 PWA Installation Debug Console</h1>
        
        <!-- כפתורי פעולה -->
        <div style="margin: 20px 0;">
            <button id="install-btn" style="display:none;">🚀 INSTALL NOW</button>
            <button onclick="runAllTests()">🔄 Run All Tests</button>
            <button onclick="clearAndRestart()">🗑️ Clear & Restart</button>
            <button onclick="forceEngagement()">⚡ Force Engagement</button>
            <button onclick="checkLighthouse()">📊 Lighthouse Check</button>
        </div>
        
        <!-- תוצאות בדיקות -->
        <div id="results"></div>
        
        <!-- לוג חי -->
        <h2>📝 Live Log:</h2>
        <div id="live-log" style="background: #000; padding: 10px; height: 300px; overflow-y: auto;"></div>
    </div>

    <script>
        const log = (msg, type = 'info') => {
            const logDiv = document.getElementById('live-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const time = new Date().toTimeString().split(' ')[0];
            entry.textContent = `[${time}] ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${msg}`);
        };

        const addResult = (title, status, details, type = 'info') => {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `check-item ${type}`;
            div.innerHTML = `
                <strong>${status ? '✅' : '❌'} ${title}</strong>
                <div style="margin-top: 5px; color: #aaa;">${details}</div>
            `;
            results.appendChild(div);
        };

        let deferredPrompt = null;
        let promptCount = 0;

        // 1. Service Worker Registration with detailed logging
        async function registerSW() {
            log('Starting Service Worker registration...', 'info');
            
            if (!('serviceWorker' in navigator)) {
                log('Service Worker NOT supported!', 'error');
                return false;
            }
            
            try {
                // Unregister all first
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let reg of registrations) {
                    log(`Unregistering old SW: ${reg.scope}`, 'warn');
                    await reg.unregister();
                }
                
                // Register new
                log('Registering new Service Worker...', 'info');
                const reg = await navigator.serviceWorker.register('/login/service-worker.js', {
                    scope: '/login/',
                    updateViaCache: 'none'
                });
                
                log(`SW Registered! Scope: ${reg.scope}`, 'success');
                
                reg.addEventListener('updatefound', () => {
                    log('New Service Worker update found!', 'warn');
                });
                
                // Wait for activation
                if (reg.installing) {
                    log('SW is installing...', 'info');
                    await new Promise(resolve => {
                        reg.installing.addEventListener('statechange', function() {
                            if (this.state === 'activated') {
                                log('SW activated!', 'success');
                                resolve();
                            }
                        });
                    });
                } else if (reg.active) {
                    log('SW already active', 'success');
                }
                
                return true;
            } catch (err) {
                log(`SW Registration failed: ${err.message}`, 'error');
                return false;
            }
        }

        // 2. Manifest validation
        async function validateManifest() {
            log('Validating manifest...', 'info');
            
            try {
                const link = document.querySelector('link[rel="manifest"]');
                if (!link) {
                    log('No manifest link in HTML!', 'error');
                    return false;
                }
                
                log(`Manifest URL: ${link.href}`, 'info');
                const response = await fetch(link.href);
                
                if (!response.ok) {
                    log(`Manifest fetch failed: ${response.status}`, 'error');
                    return false;
                }
                
                const manifest = await response.json();
                log('Manifest loaded successfully', 'success');
                
                // Detailed checks
                const checks = {
                    'name': manifest.name,
                    'short_name': manifest.short_name,
                    'start_url': manifest.start_url,
                    'display': manifest.display,
                    'scope': manifest.scope,
                    'theme_color': manifest.theme_color,
                    'background_color': manifest.background_color,
                    'icons_count': manifest.icons?.length,
                    'has_192': manifest.icons?.some(i => i.sizes?.includes('192')),
                    'has_512': manifest.icons?.some(i => i.sizes?.includes('512')),
                    'has_maskable': manifest.icons?.some(i => i.purpose?.includes('maskable'))
                };
                
                Object.entries(checks).forEach(([key, value]) => {
                    log(`  ${key}: ${value}`, value ? 'success' : 'warn');
                });
                
                // Test icon loading
                if (manifest.icons?.length > 0) {
                    const testIcon = manifest.icons[0];
                    const iconUrl = new URL(testIcon.src, location.origin).href;
                    log(`Testing icon: ${iconUrl}`, 'info');
                    
                    const img = new Image();
                    img.onload = () => log(`Icon loaded: ${testIcon.sizes}`, 'success');
                    img.onerror = () => log(`Icon failed: ${testIcon.sizes}`, 'error');
                    img.src = iconUrl;
                }
                
                return true;
            } catch (err) {
                log(`Manifest validation error: ${err.message}`, 'error');
                return false;
            }
        }

        // 3. Check all requirements
        async function checkRequirements() {
            log('Checking PWA requirements...', 'info');
            
            const checks = {
                'HTTPS': location.protocol === 'https:' || location.hostname === 'localhost',
                'Service Worker API': 'serviceWorker' in navigator,
                'Promise API': 'Promise' in window,
                'Fetch API': 'fetch' in window,
                'Notification API': 'Notification' in window,
                'Cache API': 'caches' in window,
                'IndexedDB': 'indexedDB' in window,
                'Web App Manifest': !!document.querySelector('link[rel="manifest"]'),
                'Viewport Meta': !!document.querySelector('meta[name="viewport"]'),
                'Not in iframe': window.self === window.top,
                'Cookies enabled': navigator.cookieEnabled,
                'Online': navigator.onLine
            };
            
            Object.entries(checks).forEach(([key, value]) => {
                addResult(key, value, value ? 'Supported' : 'Not supported', value ? 'success' : 'error');
            });
            
            // Browser info
            const ua = navigator.userAgent;
            log(`User Agent: ${ua}`, 'info');
            log(`Platform: ${navigator.platform}`, 'info');
            log(`Language: ${navigator.language}`, 'info');
            
            // Chrome specific
            if (ua.includes('Chrome')) {
                const version = ua.match(/Chrome\/(\d+)/)?.[1];
                log(`Chrome version: ${version}`, version >= 73 ? 'success' : 'warn');
            }
            
            return Object.values(checks).every(v => v);
        }

        // 4. Setup install prompt listener
        function setupInstallPrompt() {
            log('Setting up beforeinstallprompt listener...', 'info');
            
            window.addEventListener('beforeinstallprompt', (e) => {
                promptCount++;
                log(`🎉 beforeinstallprompt fired! (Count: ${promptCount})`, 'success');
                log(`  Platforms: ${e.platforms}`, 'info');
                
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install button
                const btn = document.getElementById('install-btn');
                btn.style.display = 'inline-block';
                btn.onclick = async () => {
                    log('Install button clicked', 'info');
                    
                    if (!deferredPrompt) {
                        log('No deferred prompt available!', 'error');
                        return;
                    }
                    
                    log('Showing install prompt...', 'info');
                    deferredPrompt.prompt();
                    
                    const result = await deferredPrompt.userChoice;
                    log(`User choice: ${result.outcome}`, result.outcome === 'accepted' ? 'success' : 'warn');
                    
                    if (result.outcome === 'accepted') {
                        log('🎊 App installed successfully!', 'success');
                    }
                    
                    deferredPrompt = null;
                };
                
                addResult('Install Prompt', true, 'Ready to install!', 'success');
            });
            
            // Check if already installed
            window.addEventListener('appinstalled', () => {
                log('🎊 App was installed!', 'success');
                addResult('Installation', true, 'App installed successfully!', 'success');
            });
            
            // Display mode check
            if (window.matchMedia('(display-mode: standalone)').matches) {
                log('App is running in standalone mode (already installed)', 'warn');
                addResult('Display Mode', true, 'Already installed!', 'info');
            } else {
                log('Running in browser mode', 'info');
            }
        }

        // 5. Force user engagement
        async function forceEngagement() {
            log('Forcing user engagement...', 'warn');
            
            // Simulate user interactions
            document.body.click();
            window.scrollTo(0, 100);
            window.scrollTo(0, 0);
            
            // Create fake interaction
            const input = document.createElement('input');
            input.style.position = 'absolute';
            input.style.left = '-9999px';
            document.body.appendChild(input);
            input.focus();
            input.click();
            document.body.removeChild(input);
            
            // Wait and check
            log('Waiting 2 seconds...', 'info');
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Check engagement metrics
            log(`Time on page: ${Math.round(performance.now()/1000)} seconds`, 'info');
            log(`Navigation type: ${performance.navigation.type}`, 'info');
            
            // Try to trigger prompt
            if (!deferredPrompt) {
                log('Prompt still not available. Reloading...', 'warn');
                setTimeout(() => location.reload(), 1000);
            } else {
                log('Prompt is available!', 'success');
            }
        }

        // 6. Clear everything and restart
        async function clearAndRestart() {
            log('Clearing all data...', 'warn');
            
            // Unregister SW
            const regs = await navigator.serviceWorker.getRegistrations();
            for (let reg of regs) {
                await reg.unregister();
                log(`Unregistered SW: ${reg.scope}`, 'info');
            }
            
            // Clear caches
            if ('caches' in window) {
                const names = await caches.keys();
                for (let name of names) {
                    await caches.delete(name);
                    log(`Deleted cache: ${name}`, 'info');
                }
            }
            
            // Clear storage
            localStorage.clear();
            sessionStorage.clear();
            
            log('All data cleared. Reloading...', 'success');
            setTimeout(() => location.reload(), 1000);
        }

        // 7. Lighthouse check
        function checkLighthouse() {
            log('Lighthouse checks:', 'info');
            log('1. Open DevTools (F12)', 'info');
            log('2. Go to Lighthouse tab', 'info');
            log('3. Check "Progressive Web App"', 'info');
            log('4. Click "Analyze page load"', 'info');
            alert('Open DevTools → Lighthouse → Check "Progressive Web App" → Analyze');
        }

        // 8. Run all tests
        async function runAllTests() {
            document.getElementById('results').innerHTML = '';
            log('=== Starting all tests ===', 'warn');
            
            // Check requirements
            await checkRequirements();
            
            // Register SW
            await registerSW();
            
            // Validate manifest
            await validateManifest();
            
            // Setup listeners
            setupInstallPrompt();
            
            // Final status
            setTimeout(() => {
                if (deferredPrompt) {
                    log('✅ READY TO INSTALL!', 'success');
                } else {
                    log('❌ Install prompt not available yet', 'error');
                    log('Try: Wait 30 seconds, interact with page, then refresh', 'warn');
                }
            }, 3000);
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            log('Page loaded. Starting tests...', 'info');
            runAllTests();
        });

        // Debug info every 5 seconds
        setInterval(() => {
            if (!deferredPrompt) {
                log(`⏱️ Waiting for prompt... (${Math.round(performance.now()/1000)}s on page)`, 'warn');
            }
        }, 5000);
    </script>
</body>
</html>